//
//  BOStatusMenuController.m
//  BootChamp
//
//  Created by Kevin Wojniak on 7/6/08.
//  Copyright 2008-2012 Kevin Wojniak. All rights reserved.
//

#import "BOStatusMenuController.h"
#import "BOBoot.h"
#import "BOMedia.h"
#import "BOHelperInstaller.h"
#import "BOLog.h"
#import "BOEFI.h"
#import "BOTaskAdditions.h"
#import "NSApplication+LoginItems.h"
#import <Sparkle/Sparkle.h>
#import "DDHotKeyCenter.h"

#define BOPrefsLaunchAtStartup	@"LaunchAtStartup"

@implementation BOStatusMenuController
{
    NSStatusItem *statusItem;
    NSMenuItem *bootMenuItem;
    NSMenuItem *altBootMenuItem;
    SUUpdater *updater;
    dispatch_once_t _checkedEFIDiskToken;
    NSString* _bootableEFIDisk;
    dispatch_queue_t _queue;
}

+ (void)initialize
{
	NSDictionary *defaults = @{BOPrefsLaunchAtStartup : @YES};
	[[NSUserDefaults standardUserDefaults] registerDefaults:defaults];
}

+ (NSImage *)statusImage
{
	NSImage *img = [[NSImage alloc] initWithSize:NSMakeSize(22.0, 22.0)];
	NSRect bounds = NSMakeRect(0.0, 0.0, [img size].width, [img size].height);
	NSSize size = NSMakeSize(5.0, 5.0);
	NSRect drawBounds = NSZeroRect;
	drawBounds.size = NSMakeSize(size.width*2+1.5, size.height*2+1.5);
	drawBounds.origin = NSMakePoint(NSMinX(bounds) + floor((NSWidth(bounds)-NSWidth(drawBounds))/2),
									NSMinY(bounds) + floor((NSHeight(bounds)-NSHeight(drawBounds))/2));
	bounds = drawBounds;
	NSBezierPath *bz = nil;
	CGFloat colors[] = {0.1, 0.25, 0.4, 0.55};
	
	[img lockFocus];
	
	NSAffineTransform *at = [NSAffineTransform transform];
	[at translateXBy:NSWidth(bounds) yBy:NSHeight(bounds)];
	[at rotateByDegrees:45.0];
	[at translateXBy:-NSWidth(bounds) yBy:-NSHeight(bounds)];
	[at concat];
	
	// top left
	[[NSColor colorWithCalibratedWhite:colors[3] alpha:1.0] set];
	bz = [NSBezierPath bezierPath];
	[bz moveToPoint:NSMakePoint(NSMinX(bounds), NSMaxY(bounds))];
	[bz lineToPoint:NSMakePoint(NSMinX(bounds)+size.width, NSMaxY(bounds))];
	[bz lineToPoint:NSMakePoint(NSMinX(bounds)+size.width, NSMaxY(bounds)-size.height)];
	[bz lineToPoint:NSMakePoint(NSMinX(bounds), NSMaxY(bounds)-size.height)];
	[bz fill];

	// top right
	[[NSColor colorWithCalibratedWhite:colors[0] alpha:1.0] set];
	bz = [NSBezierPath bezierPath];
	[bz moveToPoint:NSMakePoint(NSMaxX(bounds)-size.width, NSMaxY(bounds))];
	[bz lineToPoint:NSMakePoint(NSMaxX(bounds), NSMaxY(bounds))];
	[bz lineToPoint:NSMakePoint(NSMaxX(bounds), NSMaxY(bounds)-size.height)];
	[bz lineToPoint:NSMakePoint(NSMaxX(bounds)-size.width, NSMaxY(bounds)-size.height)];
	[bz fill];

	// bottom right
	[[NSColor colorWithCalibratedWhite:colors[1] alpha:1.0] set];
	bz = [NSBezierPath bezierPath];
	[bz moveToPoint:NSMakePoint(NSMaxX(bounds)-size.width, NSMinY(bounds)+size.height)];
	[bz lineToPoint:NSMakePoint(NSMaxX(bounds), NSMinY(bounds)+size.height)];
	[bz lineToPoint:NSMakePoint(NSMaxX(bounds), NSMinY(bounds))];
	[bz lineToPoint:NSMakePoint(NSMaxX(bounds)-size.width, NSMinY(bounds))];
	[bz fill];

	// bottom left
	[[NSColor colorWithCalibratedWhite:colors[2] alpha:1.0] set];
	bz = [NSBezierPath bezierPath];
	[bz moveToPoint:NSMakePoint(NSMinX(bounds), NSMinY(bounds)+size.height)];
	[bz lineToPoint:NSMakePoint(NSMinX(bounds)+size.width, NSMinY(bounds)+size.height)];
	[bz lineToPoint:NSMakePoint(NSMinX(bounds)+size.width, NSMinY(bounds))];
	[bz lineToPoint:NSMakePoint(NSMinX(bounds), NSMinY(bounds))];
	[bz fill];
	
	[img unlockFocus];
	[img setTemplate:YES];
	return img;
}

- (void)checkPrefs
{
    if ([[NSUserDefaults standardUserDefaults] boolForKey:BOPrefsLaunchAtStartup]) {
		[NSApp addToLoginItems];
    } else {
		[NSApp removeFromLoginItems];
    }
}

- (void)updateBootMenuTitle
{
	NSString *restartTitle = NSLocalizedString(@"Restart into Windows", "restart into windows menu item");
	NSString *altRestartTitle;
    if ([bootMenuItem representedObject]) {
        altRestartTitle = [NSString stringWithFormat:NSLocalizedString(@"Restart into %@", "restart into windows alternative menu item"), [[bootMenuItem representedObject] name]];
    } else {
        altRestartTitle = restartTitle;
    }
	if (BOAuthorizationRequired() && ([bootMenuItem target] || [bootMenuItem submenu])) {
        // Add ellipsis character to indicate the user needs to authenticate
		restartTitle = [restartTitle stringByAppendingString:@"\u2026"];
		altRestartTitle = [altRestartTitle stringByAppendingString:@"\u2026"];
	}
	[bootMenuItem setTitle:restartTitle];
    [altBootMenuItem setTitle:altRestartTitle];
}

- (void)updateBootMenu:(NSMenuItem*)menuItem withMedia:(NSArray*)media
{
	if (![media count]) {
		// no media
		[menuItem setTarget:nil];
		[menuItem setAction:nil];
		[menuItem setSubmenu:nil];
		[menuItem setRepresentedObject:nil];
	} else {
		if ([media count] == 1) {
			[menuItem setTarget:self];
			[menuItem setAction:@selector(bootWindows:)];
			[menuItem setSubmenu:nil];
			[menuItem setRepresentedObject:[media lastObject]];
            
            // Set shortcut.
            [menuItem setKeyEquivalent:@"w"];
            [menuItem setKeyEquivalentModifierMask:NSCommandKeyMask | NSAlternateKeyMask | NSControlKeyMask];
            DDHotKeyCenter *hotKeyCenter = [DDHotKeyCenter sharedHotKeyCenter];
            [hotKeyCenter registerHotKeyWithKeyCode:13 modifierFlags:NSCommandKeyMask | NSAlternateKeyMask | NSControlKeyMask
                                             target:self action:@selector(bootWindows:) object:menuItem];
		} else {
			// multiple media
			NSMenu *submenu = [[NSMenu alloc] init];
			for (BOMedia *m in media) {
				NSMenuItem *item = [[NSMenuItem alloc] initWithTitle:m.name action:@selector(bootWindows:) keyEquivalent:@""];
				[item setTarget:self];
				[item setRepresentedObject:m];
				NSImage *icon = [[NSWorkspace sharedWorkspace] iconForFile:m.mountPoint];
				[icon setSize:NSMakeSize(16.0, 16.0)];
				[item setImage:icon];
				[submenu addItem:item];
			}
			[menuItem setTarget:nil];
			[menuItem setAction:nil];
			[menuItem setSubmenu:submenu];
			[menuItem setRepresentedObject:nil];
		}
	}
}

- (void)updateBootMenuWithMedia:(NSArray *)media
{
    BOLog(@"Update menu with media: %@", media);
	[self updateBootMenuTitle];
    [self updateBootMenu:bootMenuItem withMedia:media];
    [self updateBootMenu:altBootMenuItem withMedia:media];
}

- (NSArray*)media
{
    NSArray *media = [BOMedia allMedia];
    dispatch_once(&_checkedEFIDiskToken, ^{
        _bootableEFIDisk = BOBootableEFI();
    });
    if (_bootableEFIDisk && media.count == 1) {
        // If an EFI partition is found that contains Windows boot files,
        // we need to make it the boot device instead of the NTFS partition.
        // If the NTFS partition is made bootable, the OS will attempt
        // to boot into it but the user will see "No bootable device".
        BOMedia *item = media.lastObject;
        item.deviceName = _bootableEFIDisk;
        item.legacy = NO;
    }
    return media;
}

- (void)updateBootMenu
{
	[bootMenuItem setTitle:NSLocalizedString(@"Updating\u2026", "updating drives menu item")];
	[bootMenuItem setTarget:nil];
	[bootMenuItem setAction:nil];
	[bootMenuItem setSubmenu:nil];
	[bootMenuItem setRepresentedObject:nil];
	
	// Load media objects in the background and call back to self with updateBootMenuWithMedia: when done
	dispatch_async(_queue, ^{
        NSArray *media = self.media;
		dispatch_async(dispatch_get_main_queue(), ^{
			[self updateBootMenuWithMedia:media];
		});
	});
}

- (void)workspaceDidMount:(NSNotification*)note
{
    BOLog(@"workspaceDidMount: %@", note.userInfo[@"NSDevicePath"]);
    [self updateBootMenu];
}

- (void)workspaceDidUnmount:(NSNotification*)note
{
    BOLog(@"workspaceDidUnmount: %@", note.userInfo[@"NSDevicePath"]);
    [self updateBootMenu];
}

- (instancetype)init
{
    if ((self = [super init]) != nil) {
        (void)[BOLog sharedLog]; // init log
        _queue = dispatch_queue_create("com.kainjow.BootChamp.update", NULL);
        dispatch_set_target_queue(_queue, dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0));
    }
    return self;
}

- (void)applicationDidFinishLaunching:(NSNotification * __unused)notif
{
    // Log some helpful info
    BOLog(@"%@ %@", [[NSProcessInfo processInfo] processName], [[NSBundle mainBundle] objectForInfoDictionaryKey:(id)kCFBundleVersionKey]);
    NSString *output = nil;
    (void)[NSTask launchTaskAtPath:@"/usr/sbin/diskutil" arguments:@[@"list"] output:&output];
    BOLog(@"disks\n%@", output);
    (void)[NSTask launchTaskAtPath:@"/sbin/mount" arguments:nil output:&output];
    BOLog(@"mount\n%@", output);
    
	statusItem = [[NSStatusBar systemStatusBar] statusItemWithLength:NSSquareStatusItemLength];
	[statusItem setHighlightMode:YES];
    
    // Allow the user to specify a custom image via:
    // $ defaults write com.kainjow.BootChamp StatusImage <path>
    NSString *statusImagePath = [[NSUserDefaults standardUserDefaults] objectForKey:@"StatusImage"];
    NSImage *statusImage = nil;
    if (statusImagePath != nil) {
        statusImage = [[NSImage alloc] initWithContentsOfFile:statusImagePath];
    }
    if (statusImage == nil) {
        statusImage = [[self class] statusImage];
    }
	[statusItem setImage:statusImage];
	
	NSMenu *menu = [[NSMenu alloc] init];
	[menu setDelegate:self];
	
	bootMenuItem = [[NSMenuItem alloc] initWithTitle:@"" action:nil keyEquivalent:@""];
    altBootMenuItem = [[NSMenuItem alloc] initWithTitle:@"" action:Nil keyEquivalent:@""];
    [altBootMenuItem setAlternate:YES];
    [altBootMenuItem setKeyEquivalentModifierMask:NSAlternateKeyMask];
    
	[menu addItem:bootMenuItem];
    [menu addItem:altBootMenuItem];
	[self updateBootMenu];
    [[[NSWorkspace sharedWorkspace] notificationCenter] addObserver:self selector:@selector(workspaceDidMount:) name:NSWorkspaceDidMountNotification object:nil];
    [[[NSWorkspace sharedWorkspace] notificationCenter] addObserver:self selector:@selector(workspaceDidUnmount:) name:NSWorkspaceDidUnmountNotification object:nil];
	
	[menu addItem:[NSMenuItem separatorItem]];
	
	NSMenuItem *prefsMenuItem = [menu addItemWithTitle:NSLocalizedString(@"Preferences", "preferences title menu item") action:nil keyEquivalent:@""];
    NSMenu *prefsSubMenu = [[NSMenu alloc] init];
    [prefsMenuItem setSubmenu:prefsSubMenu];
	NSMenuItem *menuItem;
	menuItem = [prefsSubMenu addItemWithTitle:NSLocalizedString(@"Launch at startup", "launch at startup menu item") action:@selector(preferenceAction:) keyEquivalent:@""];
	[menuItem setIndentationLevel:1];
	[menuItem setRepresentedObject:BOPrefsLaunchAtStartup];
    if ([[NSUserDefaults standardUserDefaults] boolForKey:BOPrefsLaunchAtStartup]) {
		[menuItem setState:NSOnState];
    }

	[menu addItemWithTitle:NSLocalizedString(@"BootChamp Help", "help menu item") action:@selector(showHelp:) keyEquivalent:@""];
	[menu addItemWithTitle:NSLocalizedString(@"Check for Updates\u2026", "check for updates menu item") action:@selector(checkforUpdates:) keyEquivalent:@""];
    [menu addItemWithTitle:NSLocalizedString(@"About BootChamp", "about menu item") action:@selector(showAbout:) keyEquivalent:@""];
	[menu addItem:[NSMenuItem separatorItem]];
	[menu addItemWithTitle:NSLocalizedString(@"Quit", "quit menu item") action:@selector(quit:) keyEquivalent:@""];
	[[menu itemArray] makeObjectsPerformSelector:@selector(setTarget:) withObject:self];
	
	[statusItem setMenu:menu];
	
	[self checkPrefs];
    
    updater = [SUUpdater sharedUpdater];
}

- (void)bootWindows:(id)sender
{
	[NSApp activateIgnoringOtherApps:YES];
	NSError *error = nil;
    if (BOBoot([sender representedObject], &error, YES)) {
		return;
    }
	[NSApp activateIgnoringOtherApps:YES]; // app may have gone inactive from auth dialog
	NSString *msg = nil, *info = nil;
	switch ([error code]) {
		case BOBootInvalidMediaError:
			msg = NSLocalizedString(@"BootChamp was unable to find a Windows volume", nil);
			info = NSLocalizedString(@"Supported file systems are FAT32 and NTFS.", nil);
			break;
		case BOBootAuthorizationError:
			msg = NSLocalizedString(@"BootChamp was unable to set your Windows volume as the temporary startup disk", nil);
			info = NSLocalizedString(@"Authentication may have failed.", nil);
			break;
		case BOBootInstallationFailed:
			msg = NSLocalizedString(@"BootChamp was unable to install its required helper tool.", nil);
			info = [error localizedDescription];
			break;
		case BOBootInternalError:
			msg = NSLocalizedString(@"BootChamp was unable to set your Windows volume as the temporary startup disk", nil);
			info = [error localizedDescription];
			break;
		case BOBootRestartFailedError:
			msg = NSLocalizedString(@"BootChamp was unable to restart your computer", nil);
			info = NSLocalizedString(@"Please restart your computer manually.", nil);
			break;
		default:
			break;
	}
	if (msg) {
		NSAlert *alert = [[NSAlert alloc] init];
		[alert setMessageText:msg];
        if (info) {
			[alert setInformativeText:info];
        }
		[alert runModal];
	}
}

- (void)showHelp:(id __unused)sender
{
	[NSApp activateIgnoringOtherApps:YES];
	NSURL *helpURL = [NSURL fileURLWithPath:[[NSBundle mainBundle] pathForResource:@"help.htm" ofType:nil]];
	[[NSWorkspace sharedWorkspace] openURLs:@[helpURL] withAppBundleIdentifier:@"com.apple.helpviewer" options:NSWorkspaceLaunchDefault additionalEventParamDescriptor:nil launchIdentifiers:NULL];
}

- (void)preferenceAction:(id __unused)sender
{
	NSString *key = [sender representedObject];
	NSInteger newState = ([sender state] == NSOnState ? NSOffState : NSOnState);
	[sender setState:newState];
	[[NSUserDefaults standardUserDefaults] setBool:(newState == NSOnState ? YES : NO) forKey:key];
	
	[self checkPrefs];
}

- (void)checkforUpdates:(id)sender
{
    [updater checkForUpdates:sender];
}

- (void)quit:(id __unused)sender
{
	[NSApp terminate:nil];
}

- (void)showAbout:(id)sender
{
    [NSApp activateIgnoringOtherApps:YES];
    [NSApp orderFrontStandardAboutPanel:sender];
}

@end
